<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Seasonal and monthly models • hydroState</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Seasonal and monthly models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hydroState</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/hydroState.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/adjust.state.model.html">Adjust the default state model</a></li>
    <li><a class="dropdown-item" href="../articles/subAnnual.models.html">Seasonal and monthly models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/peterson-tim-j/HydroState/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Seasonal and monthly models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/peterson-tim-j/HydroState/blob/master/vignettes/subAnnual.models.Rmd" class="external-link"><code>vignettes/subAnnual.models.Rmd</code></a></small>
      <div class="d-none name"><code>subAnnual.models.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/peterson-tim-j/HydroState" class="external-link">hydroState</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="sub-annual-models">Sub-annual models<a class="anchor" aria-label="anchor" href="#sub-annual-models"></a>
</h2>
<p>Seasonal and monthly models provide further insight into the state of
the rainfall-runoff relationship throughout the year, but with this more
sensitive analysis, there is often more seasonal variation and
auto-correlation. hydroState provides additional options to explain this
variation so models are statistically adequate. These options are
located within the <code><a href="../reference/build.html">build()</a></code> function. The seasonal variation
can be explained with a sinusoidal function for a particular parameter
through identifying <code>seasonal.parameters</code> in
<code><a href="../reference/build.html">build()</a></code>. This vignette provides an example of an analysis
on a seasonal time-step with the intercept, <code>a0</code>, as a
<code>seasonal.parameters</code>.</p>
</div>
<div class="section level2">
<h2 id="load-required-data">Load required data<a class="anchor" aria-label="anchor" href="#load-required-data"></a>
</h2>
<p>Seasonal and monthly rainfall-runoff models require a data frame with
catchment average runoff and precipitation for each month. Load the data
into the environment. Ensure there are four columns named “year”,
“month”, “flow”, and “precipitation”, and verify the units for flow and
precipitation are the same (‘mm’, ‘in’, etc.).</p>
<p>Note, hydroState parses the <code>input.data</code> given in
sequential order by year, month, and day (1950-01-01, 1950-01-02 or
1978-11, 1978-12, 1980-01, etc). Avoid re-labeling months in water-years
for seasonal and monthly <code>input.data</code>. Use calender
years.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">streamflow_monthly_415201</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check input data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">streamflow_monthly_415201</span><span class="op">)</span></span>
<span><span class="co">#&gt;   year month     flow precipitation</span></span>
<span><span class="co">#&gt; 1 1950     1 0.000000      2.316268</span></span>
<span><span class="co">#&gt; 2 1950     2 0.000000     86.074245</span></span>
<span><span class="co">#&gt; 3 1950     3 2.044923     58.934578</span></span>
<span><span class="co">#&gt; 4 1950     4 1.189653     40.083532</span></span>
<span><span class="co">#&gt; 5 1950     5 1.098197     82.928550</span></span>
<span><span class="co">#&gt; 6 1950     6 2.417402     20.966111</span></span></code></pre></div>
<p>For a seasonal analysis, hydroState provides an additional
<code><a href="../reference/get.seasons.html">get.seasons()</a></code> function to adjust the monthly data into
seasons. The flow and precipitation are summed every three months and
shown in the last month of the season. The number of months in each
season is included. An example of this is shown below.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># aggregate monthly data to seasonal</span></span>
<span><span class="va">streamflow_seasonal_415201</span> <span class="op">=</span> <span class="fu"><a href="../reference/get.seasons.html">get.seasons</a></span><span class="op">(</span><span class="va">streamflow_monthly_415201</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check seasonal data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">streamflow_seasonal_415201</span><span class="op">)</span></span>
<span><span class="co">#&gt;   year month      flow precipitation nmonths</span></span>
<span><span class="co">#&gt; 1 1950     5  4.332774      181.9467       3</span></span>
<span><span class="co">#&gt; 2 1950     8  6.924973      126.3109       3</span></span>
<span><span class="co">#&gt; 3 1950    11  7.729439      170.7257       3</span></span>
<span><span class="co">#&gt; 4 1951     2  7.049185      141.9339       3</span></span>
<span><span class="co">#&gt; 5 1951     5  1.395975      128.1353       3</span></span>
<span><span class="co">#&gt; 6 1951     8 36.430009      227.4161       3</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="build-a-sub-annual-hydrostate-model">Build a sub-annual hydroState model<a class="anchor" aria-label="anchor" href="#build-a-sub-annual-hydrostate-model"></a>
</h2>
<p>For seasonal and monthly models, there are additional options when
building a model. A default model can be built that is identical to the
default annual model except on a monthly or seasonal time-step OR the
model can be adjusted.</p>
<p>In addition to the options presented in <a href="adjust.state.model.html">adjusting the default state model
vignette</a>, the seasonal and monthly models can assume parameters
within the rainfall-runoff relationship vary seasonally throughout the
year. This is available within the <code>seasonal.parameters</code>.
This assumes a <code>parameter</code> is best modeled as a sinusoidal
function representing seasonal trends. The input accepts any default
parameter: <code>a1</code>, <code>a0</code>, or <code>std</code>.
Typically, assuming seasonal trends in only the intercept,
<code>a0</code>, explains trends in the residuals of the model. For
further details, see <code><a href="../reference/build.html">build()</a></code>.</p>
<p>For this analysis, an adjusted model is built on a seasonal
time-step:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build seasonal hydroState model with adjusted model, seasonal forcing</span></span>
<span><span class="va">model.seasonal.adjusted</span> <span class="op">=</span> <span class="fu"><a href="../reference/build.html">build</a></span><span class="op">(</span>input.data <span class="op">=</span> <span class="va">streamflow_seasonal_415201</span>,</span>
<span>                          parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'a0'</span>,<span class="st">'a1'</span>,<span class="st">'std'</span>,<span class="st">'AR2'</span><span class="op">)</span>,</span>
<span>                          seasonal.parameters <span class="op">=</span> <span class="st">'a0'</span>,</span>
<span>                          data.transform <span class="op">=</span> <span class="st">'boxcox'</span>,</span>
<span>                          transition.graph <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">TRUE</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fit-the-model">Fit the model<a class="anchor" aria-label="anchor" href="#fit-the-model"></a>
</h2>
<p>Fit the built models with <code><a href="../reference/fit.hydroState.html">fit.hydroState()</a></code>. This will
take typically an hour to run.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="sc">&lt;!--</span> model.seasonal.adjusted <span class="ot">=</span> <span class="fu">fit.hydroState</span>(model.seasonal.adjusted, <span class="at">pop.size.perParameter =</span> <span class="dv">10</span>, <span class="at">max.generations =</span> <span class="dv">10000</span>, <span class="at">doParallel =</span> <span class="cn">TRUE</span>)  <span class="sc">-</span><span class="ot">-&gt;</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="review-the-residuals">Review the residuals<a class="anchor" aria-label="anchor" href="#review-the-residuals"></a>
</h2>
<p>Review the model’s residuals from figures using
<code><a href="../reference/plot.hydroState.html">plot.hydroState()</a></code> to ensure they are uniform and normally
distributed with no trends or auto-correlation.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># review residual plots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model.seasonal.fitted.415201</span>, pse.residuals <span class="op">=</span> <span class="cn">TRUE</span>, siteID <span class="op">=</span> <span class="st">'415201'</span><span class="op">)</span> </span></code></pre></div>
<div class="float">
<img src="../reference/figures/subAnnual.model.residuals.png" style="width:100.0%" alt="The residual plots of the best seasonal model for site 415201 are uniform and normally distributed with the Shapiro-Wilk p-value being greater than 0.05."><div class="figcaption">The residual plots of the best seasonal model
for site 415201 are uniform and normally distributed with the
Shapiro-Wilk p-value being greater than 0.05.</div>
</div>
</div>
<div class="section level2">
<h2 id="evaluate-the-state-shifts">Evaluate the state-shifts<a class="anchor" aria-label="anchor" href="#evaluate-the-state-shifts"></a>
</h2>
<p>Set the state names relative to a year in the record using
<code><a href="../reference/setInitialYear.html">setInitialYear()</a></code>. This provides a name for the states so
they are easier to interpret in the following figures. Then plot the
state-shifts overtime using <code><a href="../reference/plot.hydroState.html">plot.hydroState()</a></code>. In this
example, 1990 is chosen as the year of reference. All four plots within
the function are shown here, but either plot or combination of plots can
be selected. Alternatively, the states can be reviewed without plotting
using <code><a href="../reference/get.states.html">get.states()</a></code> which returns a data frame of states at
each time-step.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set the reference year to name the states</span></span>
<span><span class="va">model.seasonal.fitted.415201</span> <span class="op">=</span> <span class="fu"><a href="../reference/setInitialYear.html">setInitialYear</a></span><span class="op">(</span><span class="va">model.seasonal.fitted.415201</span>, <span class="fl">1990</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># plot all four plots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model.seasonal.fitted.415201</span><span class="op">)</span></span></code></pre></div>
<center>
<div class="float">
<img src="../reference/figures/subAnnual.model.states.png" style="width:100.0%" alt="The seasonal model considers seasonality and auto-correlation within the rainfall-runoff relationship, but these model results show there are state shifts within this relationship at this site. The 3-states suggests a shift in the rainfall-runoff relationship throughout the record better represent observations. The Very Low state persist at the end of the record after a prolonged drought from roughly 1997-2009."><div class="figcaption">The seasonal model considers seasonality and
auto-correlation within the rainfall-runoff relationship, but these
model results show there are state shifts within this relationship at
this site. The 3-states suggests a shift in the rainfall-runoff
relationship throughout the record better represent observations. The
Very Low state persist at the end of the record after a prolonged
drought from roughly 1997-2009.</div>
</div>
</center>
</div>
<div class="section level2">
<h2 id="systematic-model-selection-for-sub-annual-models">Systematic model selection for sub-annual models<a class="anchor" aria-label="anchor" href="#systematic-model-selection-for-sub-annual-models"></a>
</h2>
<p>To identify the best sub-annual model, a systematic evaluation of the
possible model combinations can be performed using the
<code><a href="../reference/build.all.html">build.all()</a></code> function. Below is an example evaluating all
possible model combinations when <code>a0</code> and <code>std</code>
are the state dependent parameters, and <code>a0</code> is expressed as
a <code>seasonal.parameter</code>. The procedure is identical to the
systematic model evaluation within the <a href="adjust.state.model.html">“Adjust the default state model
vignette”</a>, expect <code>seasonal.parameters</code> may be selected.
Note, it is recommend to run this systematic analysis in parallel and on
a high-performance computer where possible. The example below can take
hours to fit 12 models when running in parallel on a 7-core, 64-bit
operating system.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># Build all possible models with the intercept, 'a0', as a seasonal parameter and state dependent parameter</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>all.models.seasonal <span class="ot">=</span> <span class="fu">build.all</span>(<span class="at">input.data =</span> streamflow_seasonal_415201,</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>                                        <span class="at">state.shift.parameter =</span> <span class="fu">c</span>(<span class="st">'a0'</span>,<span class="st">'std'</span>),</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>                                        <span class="at">seasonal.parameter =</span> <span class="st">'a0'</span>)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co"># Review the order of the reference models, adjust reference models if needed.</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>all.models.ref.table <span class="ot">=</span> <span class="fu">summary</span>(all.models.seasonal)</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="co"># Re-build with adjusted reference table</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>all.models.seasonal <span class="ot">=</span> <span class="fu">build.all</span>(<span class="at">input.data =</span> streamflow_seasonal_415201,</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>                                        <span class="at">state.shift.parameter =</span> <span class="fu">c</span>(<span class="st">'a0'</span>,<span class="st">'std'</span>),</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>                                        <span class="at">seasonal.parameter =</span> <span class="st">'a0'</span>,</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>                                        <span class="at">summary.table =</span> all.models.ref.table)</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="co"># Fit all models (takes hours to run)</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a><span class="sc">&lt;!--</span> all.models.seasonal <span class="ot">=</span> <span class="fu">fit.hydroState</span>(all.models.seasonal, <span class="at">pop.size.perParameter =</span> <span class="dv">10</span>, <span class="at">max.generations =</span> <span class="dv">10000</span>, <span class="at">doParallel =</span> T) <span class="sc">-</span><span class="ot">-&gt;</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a><span class="co"># Identify the best model with the lowest AIC</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a><span class="fu">get.AIC</span>(all.models.seasonal.fitted<span class="fl">.415201</span>)</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a><span class="co">#&gt;                                                  AIC    nParameters   AIC.weights</span></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a><span class="co">#&gt; model.3State.gamma.boxcox.AR2.a0.seasonal.a0std  92.73299          23 9.999948e-01</span></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a><span class="co">#&gt; model.3State.gamma.boxcox.AR3.a0.seasonal.a0std 117.07896          24 5.168178e-06</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a><span class="co">#&gt; model.2State.gamma.boxcox.AR3.a0.seasonal.a0std 133.67572          15 1.286464e-09</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a><span class="co">#&gt; model.3State.gamma.boxcox.AR1.a0.seasonal.a0std 150.25432          22 3.231464e-13</span></span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a><span class="co">#&gt; ...</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tim Peterson, Thomas Westfall.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
