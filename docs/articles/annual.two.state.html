<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="hydroState">
<title>Hidden Markov Modelling of hydrological state change • hydroState</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Hidden Markov Modelling of hydrological state change">
<meta property="og:description" content="hydroState">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hydroState</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/adjust.state.model.html">adjust.state.model</a>
    <a class="dropdown-item" href="../articles/annual.two.state.html">Hidden Markov Modelling of hydrological state change</a>
    <a class="dropdown-item" href="../articles/subAnnual.models.html">Seasonal and monthly models</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/peterson-tim-j/HydroState/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Hidden Markov Modelling of hydrological state change</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/peterson-tim-j/HydroState/blob/HEAD/vignettes/annual.two.state.Rmd" class="external-link"><code>vignettes/annual.two.state.Rmd</code></a></small>
      <div class="d-none name"><code>annual.two.state.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/peterson-tim-j/HydroState" class="external-link">hydroState</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># citr::tidy_bib_file(</span></span>
<span><span class="co">#   rmd_file = c("annual.two.state.Rmd", "monthly.two.state.Rmd"),</span></span>
<span><span class="co">#   messy_bibliography = "Dissertation.bib", #updated by Zotero</span></span>
<span><span class="co">#   file = "references.bib" #read in by R</span></span>
<span><span class="co"># )</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>hydroState provides methods to construct and evaluate hidden Markov
models (HMM) of annual, seasonal, or monthly streamflow runoff with
precipitation as a predictor. Streamflow and precipitation vary
overtime, and their relationship can often be non-stationary where a
change in streamflow cannot entirely be explained by a change in
precipitation. hydroState offers the necessary tools to identify this
non-stationary change in catchments overtime. This shift in the
rainfall-runoff relationship to an alternate hydrological state can even
persist after a pro-longed drought. For more detail on the underlying
methods and motive, see: Peterson TJ, Saft M, Peel MC &amp; John A
(2021), Watersheds may not recover from drought, Science, DOI:
10.1126/science.abd5085.</p>
<p>This shift to an alternate state is defined through evaluating a
linear model that simulates runoff, <span class="math inline">\(\widehat{Q}\)</span>, with precipitation, <span class="math inline">\(P\)</span>, as a predictor:<span class="math display">\[\widehat{Q} = Pa_1 + a_0\]</span> where <span class="math inline">\(a_1\)</span> and <span class="math inline">\(a_0\)</span> are constant parameters. hydroState
fits this model overtime using a hidden Markov model approach that
allows runoff to shift states at each time step. The probability of
shifting states depends on the distribution of states at prior time
steps. The shift can occur within either of the following parameters:
<span class="math inline">\(a_1\)</span>, <span class="math inline">\(a_0\)</span>, and/or the error, <span class="math inline">\(std\)</span>. The default model (worked through
here) considers a state shift in the intercept, <span class="math inline">\(a_0\)</span> and error, <span class="math inline">\(std\)</span>. This vignette provides an example of
how to build and evaluate an annual model, and this is a great place to
start. hydroState offers additional tools to refine the rainfall-runoff
relationship and evaluate on seasonal and monthly time-steps. These are
further introduced in the other vignettes.</p>
<div class="section level3">
<h3 id="load-required-data">Load required data<a class="anchor" aria-label="anchor" href="#load-required-data"></a>
</h3>
<p>Annual rainfall-runoff models require a data frame with catchment
average runoff and precipitation for each year. Load the data into the
environment. Ensure there are three columns named “year”, “flow”, and
“precipitation”, and verify the units for flow and precipitation are the
same (‘mm’, ‘in’, etc.).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">streamflow_annual_221201</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># check input data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">streamflow_annual_221201</span><span class="op">)</span></span>
<span><span class="co">#&gt;  year      flow precipitation</span></span>
<span><span class="co">#&gt; 1 1923 125.09053      961.6729</span></span>
<span><span class="co">#&gt; 2 1924  63.94195      795.7554</span></span>
<span><span class="co">#&gt; 3 1925 184.41702     1045.1675</span></span>
<span><span class="co">#&gt; 4 1926  71.62613      749.1795</span></span>
<span><span class="co">#&gt; 5 1927 130.10813      981.1049</span></span>
<span><span class="co">#&gt; 6 1928 269.01408      969.8059</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="build-a-2-state-annual-hydrostate-model">Build a 2-state annual hydroState model<a class="anchor" aria-label="anchor" href="#build-a-2-state-annual-hydrostate-model"></a>
</h3>
<p>Build the the 2-state annual hydroState model with
<code>build</code>. This model is the default and only requires input
data. The input data can have gaps in flow or precipitation. A message
will appear when gaps are in the data, but the model is still built.
Handling the gaps are discussed in the <code>build</code> documentation.
In order to adjust the default model, resort to the next vignette: <a href="https://github.com/peterson-tim-j/HydroState/tree/master/vignettes/adjust.state.model/adjust.state.model.html" class="external-link">adjust.state.model</a>.
This <code>build</code> command also accepts seasonal or monthly data if
the input data contains these time-step. See vignette: <a href="https://github.com/peterson-tim-j/HydroState/tree/master/vignettes/subAnnual.models/subAnnual.models.html" class="external-link">subAnnual.models</a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">default.model.annual</span> <span class="op">=</span> <span class="fu"><a href="../reference/build.html">build</a></span><span class="op">(</span>input.data <span class="op">=</span> <span class="va">streamflow_annual_221201</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-the-model">Fit the model<a class="anchor" aria-label="anchor" href="#fit-the-model"></a>
</h3>
<p>Fit the parameters of the built model with
<code>fit.hydroState</code>. This calibrates the model parameters
through maximum likelihood estimation by minimizing the negative
log-likelihood. For more details on the likelihood function, refer to
<code>fit.hydroState</code> documentation. The calibration procedure
optimizes the model parameters using the <a href="https://github.com/ArdiaD/DEoptim" class="external-link">DEoptim</a> R-package. When
<code>fit.hydroState</code> is initiated, the output prints the initial
negative log-likelihood value from the initial parameters, and the
calibration settings. Every 25 iterations, the best set of parameter
values, <em>bestmemit</em>, and lowest negative log-likelihood,
<em>bestvalit</em>, are printed to the console. It will take a few
seconds to completely calibrate the model. When calibration reaches the
maximum number of generations, it is recommended to increase
<code>max.generations</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">default.model.annual</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit.hydroState.html">fit.hydroState</a></span><span class="op">(</span><span class="va">default.model.annual</span>, pop.size.perParameter <span class="op">=</span> <span class="fl">10</span>, max.generations <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt;... Starting calibration using the following settings:</span></span>
<span><span class="co">#&gt;    - Initial parameter set neg. log liklihood: Inf</span></span>
<span><span class="co">#&gt;    - total population size: 90</span></span>
<span><span class="co">#&gt;    - relative tolerance: 1e-08</span></span>
<span><span class="co">#&gt;    - iterations required that meet the tolerance: 50</span></span>
<span><span class="co">#&gt;    - maximum iterations allowed: 500</span></span>
<span><span class="co">#&gt;    - DEoptim strategy type: 3 </span></span>
<span><span class="co">#&gt;Iteration: 25 bestvalit: 52.490485 bestmemit:   -4.297386    0.011387    0.008619   -2.391905    0.522673    0.335929    0.337020    0.857055    0.556159</span></span>
<span><span class="co">#&gt;Iteration: 50 bestvalit: 37.572710 bestmemit:   -4.818044    0.008852    0.015845   -2.450097    0.416463    0.121642    0.832793    0.941794    0.252304</span></span>
<span><span class="co">#&gt;Iteration: 75 bestvalit: 36.923899 bestmemit:   -4.478514    0.009273    0.016020   -2.449549    0.413689    0.121469    0.892506    0.959339    0.000972</span></span>
<span><span class="co">#&gt;Iteration: 100 bestvalit: 36.908512 bestmemit:   -6.983881    0.009347    0.016090   -2.450366    0.416905    0.120549    0.896700    0.961387    0.000126</span></span>
<span><span class="co">#&gt;Iteration: 125 bestvalit: 36.908188 bestmemit:   -7.459433    0.009366    0.016125   -2.450803    0.417723    0.120532    0.896099    0.961124    0.000000</span></span>
<span><span class="co">#&gt;Iteration: 150 bestvalit: 36.908180 bestmemit:   -7.962110    0.009364    0.016121   -2.450759    0.417812    0.120538    0.896094    0.961110    0.000000</span></span>
<span><span class="co">#&gt;Iteration: 175 bestvalit: 36.908176 bestmemit:   -8.011148    0.009365    0.016122   -2.450765    0.417787    0.120533    0.896105    0.961132    0.000000</span></span>
<span><span class="co">#&gt;Iteration: 200 bestvalit: 36.908176 bestmemit:   -8.010275    0.009365    0.016122   -2.450765    0.417787    0.120533    0.896102    0.961131    0.000000</span></span>
<span><span class="co">#&gt;... Finished Calibration.</span></span>
<span><span class="co">#&gt;    Best solution: 36.908175905606</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="review-the-residuals">Review the residuals<a class="anchor" aria-label="anchor" href="#review-the-residuals"></a>
</h3>
<p>Review the model’s residuals from figures using <code>plot</code> to
ensure they are uniform and normally distributed with no trends or
auto-correlation. A large plot with five figures (A-E) is produced and
the check for each is discussed below. There is also an option to export
the plot as a PDF with <code>do.pdf = T</code> and label plots with the
site ID (i.e. <code>ID = 221201</code>). Alternatively, the residuals
can be reviewed without plotting using <code>get.residuals</code> which
returns a data frame of the normal pseudo residuals at each time-step.
If the residuals of the fitted model do not meet these checks below,
consider adjusting the model as discussed in the next vignette (<a href="https://github.com/peterson-tim-j/HydroState/tree/master/vignettes/adjust.state.model/adjust.state.model.html" class="external-link">adjust.state.model</a>).</p>
<ol style="list-style-type: upper-alpha">
<li>Time-series of normal-pseudo residuals to ensure the residuals each
year are within the confidence intervals.</li>
<li>Auto-correlation function (ACF) of normal-pseudo residuals to ensure
there is no serial correlation in residuals. Lag spikes should be below
confidence interval at each lag (except 0).</li>
<li>Histogram of uniform-pseudo residuals should show uniform
distribution (a “box” where there is equal frequency for each residual
value)</li>
<li>Histogram of normal-pseudo residuals should show normal distribution
centered on zero and with no skew</li>
<li>Quantile-Quantile (Q-Q) plot where normal-pseudo residuals
vs. theoretical quantities should align on the diagonal line. This last
plot contains the Akaike information criterion (AIC) and Shapiro-Wilk
p-value.
<ul>
<li>The AIC is an estimator to determine the most parsimonious, best
performing model given the number of parameters. When comparing models,
the lowest AIC is the best performing model.</li>
<li>Shapiro-Wilks test for normality in the residuals. A p-value greater
than 0.05 (chosen alpha level) indicates the residuals are normally
distributed</li>
</ul>
</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># review residual plots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">default.model.annual</span>, pse.residuals <span class="op">=</span> <span class="cn">TRUE</span>, siteID <span class="op">=</span> <span class="st">'221201'</span>, do.pdf <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get residual values</span></span>
<span><span class="va">model.residuals</span> <span class="op">=</span> <span class="fu"><a href="../reference/get.residuals.html">get.residuals</a></span><span class="op">(</span><span class="va">default.model.annual</span><span class="op">)</span></span></code></pre></div>
<center>
<div class="float">
<img src="annual.two.state.residuals.png" style="width:70.0%" alt="Residual plots to diagnose the fit of the annual model"><div class="figcaption">Residual plots to diagnose the fit of the annual
model</div>
</div>
</center>
</div>
<div class="section level3">
<h3 id="evaluate-the-state-shifts">Evaluate the state-shifts<a class="anchor" aria-label="anchor" href="#evaluate-the-state-shifts"></a>
</h3>
<p>Set the state names relative to a year in the record using
<code>setInitialYear</code>. This provides a name for the states so they
are easier to interpret in the following figures. Then plot the
state-shifts overtime using <code>plot</code>. In this example, 1990 is
chosen as the year of reference, but any year can be selected as the
reference year. All four plots within the function are shown here, but
either plot or combination of plots can be selected, see
<code>plot</code> in the <a href="https://github.com/peterson-tim-j/HydroState/hydroState.pdf" class="external-link">hydroState
user manual</a>. Alternatively, the states can be reviewed without
plotting using <code>get.states</code> which returns a data frame of
states at each time-step.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set the reference year to name the states</span></span>
<span><span class="va">default.model.annual</span> <span class="op">=</span> <span class="fu"><a href="../reference/setInitialYear.html">setInitialYear</a></span><span class="op">(</span><span class="va">default.model.annual</span>, <span class="fl">1990</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot all four plots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">default.model.annual</span><span class="op">)</span> </span></code></pre></div>
<center>
<div class="float">
<img src="annual.two.state.timeseries.png" style="width:70.0%" alt="Timeseries plot of annual runoff states"><div class="figcaption">Timeseries plot of annual runoff states</div>
</div>
</center>
<p>To only receive the results without plotting a figure, use
<code>get.states</code>. This exports the Viterbi flow states, Normal
flow state, conditional probabilities, and emission density. Please
refer to <code>get.states</code> in the <a href="https://github.com/peterson-tim-j/HydroState/hydroState.pdf" class="external-link">hydroState
user manual</a> for further explanation .</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># get data frame of state values</span></span>
<span><span class="va">model.states</span> <span class="op">=</span> <span class="fu"><a href="../reference/get.states.html">get.states</a></span><span class="op">(</span><span class="va">default.model.annual</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">model.states</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tim Peterson, Thomas Westfall.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
